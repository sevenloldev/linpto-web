---
import SearchIcon from "@/components/fundations/icons/Search.astro";
import { getCollection } from "astro:content";

const lawyers = (await getCollection("lawyers")).map((entry) => ({
  title: entry.data.name,
  description: entry.data.title + " — " + (entry.data.specialties?.join("、") || ""),
  slug: entry.slug,
  collection: "lawyers",
  collectionLabel: "律師",
  href: `/lawyers/${entry.slug}`,
}));

const cases = (await getCollection("cases")).map((entry) => ({
  title: entry.data.title,
  description: entry.data.summary,
  slug: entry.slug,
  collection: "cases",
  collectionLabel: "案例",
  href: `/cases/${entry.slug}`,
}));

const searchItems = [...lawyers, ...cases];
---

<div class="relative">
  <button
    type="button"
    data-search-trigger
    class="flex items-center justify-center size-11 rounded-lg text-base-900 dark:text-white bg-base-50 dark:bg-base-800 hover:bg-base-100 dark:hover:bg-base-700 transition-colors duration-300 cursor-pointer touch-manipulation"
    aria-label="搜尋內容"
  >
    <SearchIcon size="base" />
  </button>
</div>

<!-- Single shared modal (rendered once, outside of nav) -->
<div
  data-search-modal
  class="fixed inset-0 z-[999] overflow-y-auto hidden"
  role="dialog"
  aria-modal="true"
>
  <div class="min-h-screen px-4 text-center">
    <div
      class="fixed inset-0 bg-base-950/50 backdrop-blur transition-opacity"
      data-search-overlay
    ></div>
    <div
      class="inline-block w-full max-w-2xl px-8 mb-8 mt-12 lg:mt-48 text-left align-middle transition-all transform relative"
    >
      <div class="flex items-center justify-end mb-2">
        <button
          type="button"
          data-search-close
          class="text-base-300 hover:text-white text-sm cursor-pointer touch-manipulation p-2"
          aria-label="關閉搜尋"
        >
          ✕ 關閉
        </button>
      </div>
      <input
        type="text"
        data-search-input
        placeholder="搜尋律師、案例…"
        autocomplete="off"
        autocapitalize="off"
        class="w-full flex-auto appearance-none rounded-md outline outline-base-200 dark:outline-base-800 dark:text-white text-base-900 outline-inset border-transparent px-4 py-3 shadow-base-800/5 dark:placeholder:text-base-400 duration-300 h-12 text-base focus:border-base-500 focus:outline-none focus:outline-4 focus:outline-base-500/10 bg-base-50 dark:bg-base-800"
      />
      <div
        data-search-results
        class="max-h-100 mt-2 overflow-y-auto bg-white dark:bg-black overflow-hidden w-full divide-y divide-base-200 border-y border-base-200 dark:border-y-black dark:divide-base-900 scrollbar-hide hidden"
      ></div>
    </div>
  </div>
</div>

<script is:inline define:vars={{ searchItems }}>
  (function () {
    if (window.__searchInitialized) return;
    window.__searchInitialized = true;

    var modal = document.querySelector("[data-search-modal]");
    var overlay = document.querySelector("[data-search-overlay]");
    var input = document.querySelector("[data-search-input]");
    var results = document.querySelector("[data-search-results]");
    var closeBtn = document.querySelector("[data-search-close]");

    if (!modal || !input) return;

    var fuse = new Fuse(searchItems, {
      keys: ["title", "description", "collection"],
      threshold: 0.3,
      includeMatches: true,
    });

    function openSearch() {
      modal.classList.remove("hidden");
      document.body.style.overflow = "hidden";
      setTimeout(function () {
        input.focus();
      }, 150);
    }

    function closeSearch() {
      modal.classList.add("hidden");
      document.body.style.overflow = "";
      input.value = "";
      results.innerHTML = "";
      results.classList.add("hidden");
    }

    function renderResults(items) {
      if (!input.value.trim()) {
        results.innerHTML = "";
        results.classList.add("hidden");
        return;
      }
      if (items.length === 0) {
        results.innerHTML =
          '<div class="p-8"><p class="font-medium text-sm text-base-500">找不到相關內容…</p></div>';
        results.classList.remove("hidden");
        return;
      }
      results.innerHTML = items
        .map(function (r) {
          var item = r.item;
          var meta = item.collectionLabel
            ? '<div class="flex items-center gap-2"><span class="text-[11px] font-medium text-base-600 bg-base-50 dark:bg-base-900/50 border border-base-200 dark:border-base-800 rounded-full px-2 py-1">' +
              item.collectionLabel +
              "</span></div>"
            : "";
          return (
            '<a href="' + item.href +
            '" class="block p-6 hover:bg-base-50 duration-300 dark:hover:bg-base-950">' +
            meta +
            '<h3 class="font-medium text-sm mt-2 text-base-900 dark:text-white block">' +
            item.title + "</h3>" +
            '<p class="text-base-500 text-xs block">' +
            item.description + "</p></a>"
          );
        })
        .join("");
      results.classList.remove("hidden");
    }

    // Bind ALL trigger buttons (desktop + mobile)
    var triggers = document.querySelectorAll("[data-search-trigger]");
    for (var i = 0; i < triggers.length; i++) {
      triggers[i].addEventListener("click", function (e) {
        e.stopPropagation();
        openSearch();
      });
    }

    closeBtn.addEventListener("click", function (e) {
      e.stopPropagation();
      closeSearch();
    });

    overlay.addEventListener("click", closeSearch);

    input.addEventListener("input", function (e) {
      var value = e.target.value.trim();
      var items = value ? fuse.search(value) : [];
      renderResults(items);
    });

    document.addEventListener("keydown", function (e) {
      if (e.key === "Escape" && !modal.classList.contains("hidden")) {
        closeSearch();
      }
    });
  })();
</script>
