---
import Button from "@/components/fundations/elements/Button.astro";
import SearchIcon from "@/components/fundations/icons/Search.astro";
import { getCollection } from "astro:content";

const lawyers = (await getCollection("lawyers")).map((entry) => ({
  title: entry.data.name,
  description: entry.data.title + " — " + (entry.data.specialties?.join("、") || ""),
  slug: entry.slug,
  collection: "lawyers",
  collectionLabel: "律師",
  href: `/lawyers/${entry.slug}`,
}));

const cases = (await getCollection("cases")).map((entry) => ({
  title: entry.data.title,
  description: entry.data.summary,
  slug: entry.slug,
  collection: "cases",
  collectionLabel: "案例",
  href: `/cases/${entry.slug}`,
}));

const searchItems = [...lawyers, ...cases];
---

<div class="relative">
  <Button
    iconOnly
    size="sm"
    variant="muted"
    type="button"
    id="searchButton"
    aria-label="搜尋內容"
  >
    <SearchIcon slot="icon" size="base" />
  </Button>
  <div
    id="searchModal"
    class="fixed inset-0 z-50 overflow-y-auto hidden"
    role="dialog"
    aria-modal="true"
  >
    <div class="min-h-screen px-4 text-center">
      <div
        class="fixed inset-0 bg-base-950/50 backdrop-blur transition-opacity"
        id="modalOverlay"
      >
      </div>
      <div
        class="inline-block w-full max-w-2xl px-8 mb-8 mt-12 lg:mt-48 text-left align-middle transition-all transform relative"
      >
        <div class="hidden">
          <button
            type="button"
            id="closeSearch"
            class="text-base-400 hover:text-base-500 cursor-pointer ml-auto"
            aria-label="關閉搜尋"
          >
          </button>
        </div>
        <input
          type="text"
          id="searchInput"
          placeholder="搜尋律師、案例…"
          class="w-full flex-auto appearance-none rounded-md outline outline-base-200 dark:outline-base-800 dark:text-white text-base-900 outline-inset border-transparent px-3 py-2 shadow-base-800/5 dark:placeholder:text-base-400 duration-300 h-9 focus:border-base-500 focus:outline-none focus:outline-4 focus:outline-base-500/10 sm:text-sm bg-base-50 dark:bg-base-800"
        />
        <div
          id="searchResults"
          class="max-h-100 mt-2 overflow-y-auto bg-white dark:bg-black overflow-hidden w-full divide-y divide-base-200 border-y border-base-200 dark:border-y-black dark:divide-base-900 scrollbar-hide"
        >
        </div>
      </div>
    </div>
  </div>
</div>
<script is:inline define:vars={{ searchItems }}>
  window.addEventListener("load", () => {
    const searchButton = document.getElementById("searchButton");
    const searchModal = document.getElementById("searchModal");
    const modalOverlay = document.getElementById("modalOverlay");
    const searchInput = document.getElementById("searchInput");
    const searchResults = document.getElementById("searchResults");
    const closeSearch = document.getElementById("closeSearch");
    const fuse = new Fuse(searchItems, {
      keys: ["title", "description", "collection"],
      threshold: 0.3,
      includeMatches: true,
    });
    searchResults.classList.add("hidden");
    function openSearch(e) {
      e.preventDefault();
      e.stopPropagation();
      searchModal.classList.remove("hidden");
      document.body.style.overflow = "hidden";
      setTimeout(() => searchInput.focus(), 100);
    }
    function closeSearchModal(e) {
      if (e) {
        e.preventDefault();
        e.stopPropagation();
      }
      searchModal.classList.add("hidden");
      document.body.style.overflow = "";
      searchInput.value = "";
      searchResults.innerHTML = "";
      searchResults.classList.add("hidden");
    }
    function renderResults(results) {
      if (!searchInput.value.trim()) {
        searchResults.innerHTML = "";
        searchResults.classList.add("hidden");
        return;
      }
      if (results.length === 0) {
        searchResults.innerHTML = `
        <div class="p-8">
            <p class="font-medium text-sm text-base-500">
              找不到相關內容…
            </p>
        </div>
        `;
        searchResults.classList.remove("hidden");
        return;
      }
      searchResults.innerHTML = results
        .map(({ item }) => {
          const meta = item.collectionLabel
            ? `<div class="flex items-center gap-2"><span class="text-[11px] font-medium text-base-600 bg-base-50 dark:bg-base-900/50 border border-base-200 dark:border-base-800 rounded-full px-2 py-1">${item.collectionLabel}</span></div>`
            : "";
          return `
            <a href="${item.href}" class="block p-8 hover:bg-base-50 duration-300 dark:hover:bg-base-950">
              ${meta}
              <h3 class="font-medium text-sm mt-2 text-base-900 dark:text-white block">
                ${item.title}
              </h3>
              <p class="text-base-500 text-xs block">
                ${item.description}
              </p>
            </a>
          `;
        })
        .join("");
      searchResults.classList.remove("hidden");
    }
    searchButton.addEventListener("click", openSearch);
    searchButton.addEventListener("touchend", openSearch);
    closeSearch.addEventListener("click", closeSearchModal);
    closeSearch.addEventListener("touchend", closeSearchModal);
    modalOverlay.addEventListener("click", closeSearchModal);
    modalOverlay.addEventListener("touchend", closeSearchModal);
    searchInput.addEventListener("input", (e) => {
      const value = e.target.value.trim();
      const results = value ? fuse.search(value) : [];
      renderResults(results);
    });
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && !searchModal.classList.contains("hidden")) {
        closeSearchModal();
      }
    });
  });
</script>
